var y=Object.defineProperty;var A=(s,t,e)=>t in s?y(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var o=(s,t,e)=>A(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();class S{constructor(t){o(this,"baudrate",9600);o(this,"buffer_size",1024*1024);o(this,"traceLog","");o(this,"lastTraceTime",Date.now());o(this,"tracing",!0);o(this,"leftOver",new Uint8Array(0));o(this,"reader");o(this,"slipReaderEnabled",!0);o(this,"trace_dom_log",!0);this.device=t,console.log("SerialTransport intialized")}_appendBuffer(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer}async read(t=0,e=12){let i,r=this.leftOver;if(this.leftOver=new Uint8Array(0),this.slipReaderEnabled){const n=this.slipReader(r);if(n.length>0)return n;r=this.leftOver,this.leftOver=new Uint8Array(0)}if(this.device.readable==null)return this.leftOver;this.reader=this.device.readable.getReader();try{t>0&&(i=setTimeout(()=>{this.reader&&this.reader.cancel()},t));do{if(!this.reader)throw new Error("Reader is undefined");const{value:n,done:a}=await this.reader.read();if(a&&(this.leftOver=r,console.log("Timeout")),!n)break;r=new Uint8Array(this._appendBuffer(r.buffer,n.buffer))}while(r.length<e)}finally{if(t>0&&clearTimeout(i),!this.reader)throw new Error("Reader is undefined");this.reader.releaseLock()}if(this.tracing&&(console.log("Read bytes"),this.trace(`Read ${r.length} bytes: ${this.hexConvert(r)}`)),this.slipReaderEnabled){const n=this.slipReader(r);return this.tracing&&(console.log("Slip reader results"),this.trace(`Read ${n.length} bytes: ${this.hexConvert(n)}`)),n}return r}slipReader(t){let a=[],d=!1;for(const _ of t)_!==15968&&(_===219?d=!0:d?(_===220?a.push(15968):_===221&&a.push(219),d=!1):a.push(_));return new Uint8Array(a)}trace(t){const r=`${`TRACE ${(Date.now()-this.lastTraceTime).toFixed(3)}`} ${t}`;if(console.log(r),this.traceLog+=r+`
`,this.trace_dom_log){const n=document.querySelector("#traceLog");n&&(n.value+=this.traceLog,n.scrollTop=n.scrollHeight)}}hexify(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("").padEnd(16," ")}hexConvert(t,e=!0){if(e&&t.length>16){let i="",r=t;for(;r.length>0;){const n=r.slice(0,16),a=String.fromCharCode(...n).split("").map(d=>d===" "||d>=" "&&d<="~"&&d!=="  "?d:".").join("");r=r.slice(16),i+=`
    ${this.hexify(n.slice(0,8))} ${this.hexify(n.slice(8))} | ${a}`}return i}else return this.hexify(t)}debug(t,e,i=!0,r=!0,n="#console"){if(i&&console.log(t,e),r){const a=document.querySelector(`${n}`);a&&(a.value+=t+`
`,a.scrollTop=a.scrollHeight)}}async sleep(t){return new Promise(e=>setTimeout(e,t))}async connect(t=this.baudrate){try{await this.device.open({baudRate:t,bufferSize:this.buffer_size}),this.debug("Device Connected"),this.leftOver=new Uint8Array(0)}catch(e){this.debug("Error in connect",e)}}async send(t){if(this.device.writable){const e=this.device.writable.getWriter();await e.write(t),this.debug("Data sent",t,!0,!1),e.releaseLock()}}intelHexToUint8Array(t){const e=t.trim().split(`
`),i=[];return e.forEach(r=>{if(r.startsWith(":")){const n=parseInt(r.substr(1,2),16),a=9,d=a+n*2;for(let _=a;_<d;_+=2)i.push(parseInt(r.substr(_,2),16))}}),new Uint8Array(i)}async receive(t=0){if(this.leftOver.length!=0){const i=this.leftOver;return this.leftOver=new Uint8Array(0),i}if(!this.device.readable)return this.leftOver;this.reader=this.device.readable.getReader();let e;try{if(t>0&&(e=setTimeout(()=>{this.reader&&this.reader.cancel()},t)),!this.reader)throw new Error("Reader is undefined");const{value:i,done:r}=await this.reader.read();return console.log("Raw Read bytes",i),r?i||new Uint8Array(0):(this.tracing&&(console.log("Raw Read bytes"),this.trace(`Read ${i.length} bytes: ${this.hexConvert(i)}`)),i)}finally{if(t>0&&clearTimeout(e),!this.reader)throw new Error("Reader is undefined");this.reader.releaseLock()}}}var h=(s=>(s[s.ALIGN_DEFAULT=0]="ALIGN_DEFAULT",s[s.ALIGN_TOP_LEFT=1]="ALIGN_TOP_LEFT",s[s.ALIGN_TOP_MID=2]="ALIGN_TOP_MID",s[s.ALIGN_TOP_RIGHT=3]="ALIGN_TOP_RIGHT",s[s.ALIGN_BOTTOM_LEFT=4]="ALIGN_BOTTOM_LEFT",s[s.ALIGN_BOTTOM_MED=5]="ALIGN_BOTTOM_MED",s[s.ALIGN_BOTTOM_RIGHT=6]="ALIGN_BOTTOM_RIGHT",s[s.ALIGN_LEFT_MID=7]="ALIGN_LEFT_MID",s[s.ALIGN_RIGHT_MID=8]="ALIGN_RIGHT_MID",s[s.ALIGN_CENTER=9]="ALIGN_CENTER",s))(h||{}),f=(s=>(s[s.BSL_ACK=0]="BSL_ACK",s[s.BSL_ERROR_HEADER_INCORRECT=81]="BSL_ERROR_HEADER_INCORRECT",s[s.BSL_ERROR_CHECKSUM_INCORRECT=82]="BSL_ERROR_CHECKSUM_INCORRECT",s[s.BSL_ERROR_PACKET_SIZE_ZERO=83]="BSL_ERROR_PACKET_SIZE_ZERO",s[s.BSL_ERROR_PACKET_SIZE_TOO_BIG=84]="BSL_ERROR_PACKET_SIZE_TOO_BIG",s[s.BSL_ERROR_UNKNOWN_ERROR=85]="BSL_ERROR_UNKNOWN_ERROR",s[s.BSL_ERROR_UNKNOWN_BAUD_RATE=86]="BSL_ERROR_UNKNOWN_BAUD_RATE",s))(f||{});class c{static softwareCRC(t,e){let i=4294967295;for(let r=0;r<e;r++){let n=t[r];i=i^n;for(let a=0;a<8;a++){const d=-(i&1);i=i>>>1^this.CRC32_POLYNOMIAL&d}}return i=i>>>0,new Uint8Array([i&255,i>>>8&255,i>>>16&255,i>>>24&255])}static async getFrameRaw(t){switch(t.type){case"Connection":{const e=this.softwareCRC(new Uint8Array([this.CONNECTION]),1);return new Uint8Array([this.HEADER,1,0,this.CONNECTION,...e])}case"StartApp":{const e=this.softwareCRC(new Uint8Array([this.START_APP]),1);return new Uint8Array([this.HEADER,1,0,this.START_APP,...e])}case"GetDeviceInfo":{const e=this.softwareCRC(new Uint8Array([this.GET_DEVICE_INFO]),1);return new Uint8Array([this.HEADER,1,0,this.GET_DEVICE_INFO,...e])}case"MassErase":{const e=this.softwareCRC(new Uint8Array([this.MASS_ERASE]),1);return new Uint8Array([this.HEADER,1,0,this.MASS_ERASE,...e])}case"ProgramData":{const e=t.data,i=[t.start_address>>24&255,t.start_address>>16&255,t.start_address>>8&255,t.start_address&255],r=e.length+4+1,n=this.softwareCRC(new Uint8Array([this.PROGRAM_DATA,...i,...e]),r);return new Uint8Array([this.HEADER,r&255,r>>8,this.PROGRAM_DATA,...i,...e,...n])}case"UnlockBootloader":{const e=t.password,i=e.length+1,r=this.softwareCRC(new Uint8Array([this.UNLOCK_BOOTLOADER,...e]),i);return new Uint8Array([this.HEADER,i&255,i>>8,this.UNLOCK_BOOTLOADER,...e,...r])}default:throw new Error("Unimplemented command")}}static getResponse(t,e){switch(e.type){case"Connection":case"StartApp":return{type:e.type,response:t[0]};case"MassErase":case"ProgramData":case"UnlockBootloader":return{type:e.type,response:t[5]};case"GetDeviceInfo":return{type:e.type,response:t[5],CMD_interpreter_version:t[this.OFFSET_BYTE+2]<<8|t[this.OFFSET_BYTE+1],build_id:t[this.OFFSET_BYTE+4]<<8|t[this.OFFSET_BYTE+3],app_version:t[this.OFFSET_BYTE+8]<<24|t[this.OFFSET_BYTE+7]<<16|t[this.OFFSET_BYTE+6]<<8|t[this.OFFSET_BYTE+5],active_plugin_interface_version:t[this.OFFSET_BYTE+10]<<8|t[this.OFFSET_BYTE+9],BSL_max_buffer_size:t[this.OFFSET_BYTE+12]<<8|t[this.OFFSET_BYTE+11],BSL_buffer_start_address:t[this.OFFSET_BYTE+16]<<24|t[this.OFFSET_BYTE+15]<<16|t[this.OFFSET_BYTE+14]<<8|t[this.OFFSET_BYTE+13],BCR_config_id:t[this.OFFSET_BYTE+20]<<24|t[this.OFFSET_BYTE+19]<<16|t[this.OFFSET_BYTE+18]<<8|t[this.OFFSET_BYTE+17],BSL_config_id:t[this.OFFSET_BYTE+24]<<24|t[this.OFFSET_BYTE+23]<<16|t[this.OFFSET_BYTE+22]<<8|t[this.OFFSET_BYTE+21]};default:throw new Error("Unimplemented command")}}}o(c,"HEADER",128),o(c,"CONNECTION",18),o(c,"UNLOCK_BOOTLOADER",33),o(c,"FLASH_RANGE_ERASE",35),o(c,"MASS_ERASE",21),o(c,"PROGRAM_DATA",32),o(c,"PROGRAM_DATA_FAST",36),o(c,"MEMORY_READ",41),o(c,"FACTORY_RESET",48),o(c,"GET_DEVICE_INFO",25),o(c,"STANDALONE_VERIFY",49),o(c,"START_APP",64),o(c,"CRC32_POLYNOMIAL",3988292384),o(c,"INITIAL_SEED",4294967295),o(c,"OFFSET_BYTE",4);class L extends S{constructor(e){super(e);o(this,"conn_established",!1);o(this,"FLASH_START_ADDRESS",0);o(this,"FLASH_MAX_BUFFER_SIZE",0);o(this,"BSL_PW_RESET",[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]);o(this,"MEMORY_READ_RESPONSE",48);o(this,"DEVICE_INFO_RESPONSE",49);o(this,"STANDALONE_VERIFY_RESPONSE",50);o(this,"MESSAGE_RESPONSE",59);o(this,"ERROR_RESPONSE",58);o(this,"ESP_CMD",{BSL_ENBL:["B","S","L"],OLED_CLR:["O","L","D","R","S","T"],OLED_ON:["O","L","D","O","N"],OLED_OFF:["O","L","D","O","F","F"],OLED_PRINT:["O","L","D","W","R","T"]})}sa2a(e){let i=new Uint8Array(e.length);for(let r=0;r<e.length;r++)i[r]=e[r].charCodeAt(0);return i}s2a(e){let i=new Uint8Array(e.length);for(let r=0;r<e.length;r++)i[r]=e.charCodeAt(r);return i}async enableBSL(){await this.send(new Uint8Array(this.sa2a(this.ESP_CMD.BSL_ENBL))),await this.read(2e3,5),await this.esp_oled_print("BSL",h.ALIGN_TOP_LEFT,0,0),await this.sleep(100)}async control_esp_oled(e){await this.send(this.sa2a(e)),await this.receive()}async establish_conn(){this.debug("Enabling BSL Mode..."),await this.enableBSL();let e={type:"Connection"},i=await c.getFrameRaw(e);await this.send(i);let r=await this.receive(),n=c.getResponse(r,e);if(n.response==f.BSL_ACK)this.conn_established=!0,this.debug("BSL Mode Enabled"),await this.get_device_info();else throw this.debug("BSL Mode Enable Failed",n.response),this.conn_established=!1,new Error("BSL Mode Enable Failed")}check_crc(e){const i=e[3]<<8|e[2],r=e.slice(4,3+i),n=c.softwareCRC(r,i),a=n[0]<<24|n[1]<<16|n[2]<<8|n[3],d=e[e.length-4]<<24|e[e.length-3]<<16|e[e.length-2]<<8|e[e.length-1];if(a!=d)throw this.debug("CRC Check Failed"),new Error("CRC Check Failed");return!0}async get_device_info(){this.conn_established||this.establish_conn();const e={type:"GetDeviceInfo"},i=await c.getFrameRaw(e);await this.send(i);const r=await this.receive(),n=this.slipReader(r);this.check_crc(n);let a=c.getResponse(n,e);a.response==f.BSL_ACK&&a.type=="GetDeviceInfo"?(this.FLASH_MAX_BUFFER_SIZE=a.BSL_max_buffer_size,this.FLASH_START_ADDRESS=a.BSL_buffer_start_address,this.debug(`Device Info:
        CMD_interpreter_version: 0x${a.CMD_interpreter_version.toString(16)}
        build_id: 0x${a.build_id.toString(16)}
        app_version: 0x${a.app_version.toString(16)}
        active_plugin_interface_version: 0x${a.active_plugin_interface_version.toString(16)}
        BSL_max_buffer_size: 0x${a.BSL_max_buffer_size.toString(16)}
        BSL_buffer_start_address: 0x${a.BSL_buffer_start_address.toString(16)}
        BCR_config_id: 0x${a.BCR_config_id.toString(16)}
        BSL_config_id: 0x${a.BSL_config_id.toString(16)}`),await this.unlock_bootloader()):this.debug("Device Info Failed",a.response)}async unlock_bootloader(){this.conn_established||await this.establish_conn(),this.debug("Unlocking Bootloader ...");let e={type:"UnlockBootloader",password:new Uint8Array(this.BSL_PW_RESET)},i=await c.getFrameRaw(e);await this.send(i);let r=await this.receive(),n=c.getResponse(r,e);if(n.response==f.BSL_ACK)this.debug("Bootloader Unlocked");else throw this.debug("Bootloader Unlock Failed",n.response),new Error("Bootloader Unlock Failed")}async mass_earse(){this.conn_established||await this.establish_conn(),await this.esp_oled_print("Erasing ...",h.ALIGN_TOP_LEFT,0,0),this.debug("Mass Erasing ...");let e={type:"MassErase"},i=await c.getFrameRaw(e);await this.send(i),console.log("send is",this.hexify(i));let r=await this.receive(),n=c.getResponse(r,e);n.response==f.BSL_ACK?(this.debug("Mass Erase Done"),this.esp_oled_print("Erase Done",h.ALIGN_TOP_LEFT,0,0)):(this.debug("Mass Erase Failed",n.response),this.esp_oled_print("Erase Failed",h.ALIGN_TOP_LEFT,0,0))}async esp_oled_print(e,i=h.ALIGN_DEFAULT,r=0,n=0){await this.send(new Uint8Array(this.sa2a(this.ESP_CMD.OLED_CLR))),await this.receive();let a=new Uint8Array([...this.sa2a(this.ESP_CMD.OLED_PRINT),i,r,n,...this.s2a(e)]);await this.send(a),await this.receive()}async program_data(e){this.conn_established||await this.establish_conn(),await this.esp_oled_print("Flashing...",h.ALIGN_TOP_LEFT,0,0);const i=this.intelHexToUint8Array(e);let r=0;console.log("adress",r);const n={type:"ProgramData",start_address:r,data:i};let a=await c.getFrameRaw(n);await this.send(a);let d=await this.receive(),_=c.getResponse(d,n);if(_.response==f.BSL_ACK)this.debug("Data Programmed"),this.esp_oled_print("Flashed",h.ALIGN_TOP_LEFT,0,0);else throw this.debug("Data Program Failed",_.response),new Error("Data Program Failed")}async flash_earse_range(){this.debug("to be implemneted ")}async verifyFlash(){this.debug("to be implemneted ")}async start_app(){this.conn_established||this.establish_conn();let e={type:"StartApp"},i=await c.getFrameRaw(e);await this.send(i);let r=await this.receive(),n=c.getResponse(r,e);n.response==f.BSL_ACK?(this.conn_established=!1,this.esp_oled_print("App Started",h.ALIGN_TOP_LEFT,0,0),this.debug("App Started")):this.debug("App Start Failed",n.response)}}let E=!1,T,l,u;const w=[{usbVendorId:12346,usbProductId:4097},{usbVendorId:45488,usbProductId:32853}];function b(s){s.addEventListener("click",()=>{if(E&&T){T.disconnect(),s.innerHTML="Connect",E=!1;return}s.innerHTML="Connecting...",navigator.serial.requestPort({filters:w}).then(async t=>{l=await new L(t),await l.connect(),s.innerHTML="Connected",E=!0}).catch(t=>{console.error(t),l.debug("Error Connecting"),T.disconnect(),s.innerHTML="Connect",E=!1})})}function F(s){s.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}s.innerHTML="Erasing...";try{await l.mass_earse()}catch(t){console.log(t),l.debug("Error Erasing")}s.innerHTML="Mass Erase"})}function C(s){s.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}if(!u){l.debug("Please upload a .Hex file first");return}s.innerHTML="Flashing...";try{await l.program_data(u),l.debug("Flashing Done")}catch{l.debug("Error Flashing")}s.innerHTML="Flash"})}function O(s){s.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}if(!u){l.debug("Please upload a .Hex file first");return}s.innerHTML="Verifying...";try{await l.verifyFlash()}catch(t){console.log(t),l.debug("Error Verifying")}s.innerHTML="Verify"})}function R(s){return new Promise((t,e)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=e,i.readAsText(s)})}function v(s){s.addEventListener("change",async t=>{u="";const e=t.target.files[0];e&&e.name.endsWith(".hex")?(u=await R(e),console.log(u)):l.debug("Please upload a valid .hex file")})}function I(s){s.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}s.innerHTML="Resting...",await l.start_app(),s.innerHTML="Reset"})}function N(s){s.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}s.innerHTML="Getting Device Info...";try{await l.establish_conn()}catch(t){console.log(t),l.debug("Error Getting Device Info")}s.innerHTML="Get Device Info"})}function B(s,t,e){s.addEventListener("dragover",i=>{i.preventDefault(),s.style.borderColor="#646cff"}),s.addEventListener("dragleave",()=>{s.style.borderColor="#ccc"}),s.addEventListener("drop",async i=>{if(i.preventDefault(),s.style.borderColor="#ccc",!i.dataTransfer)return;const r=i.dataTransfer.files;r.length>0&&(e.style.display="block",t.files=r,r&&r[0].name.endsWith(".hex")?(u=await R(r[0]),console.log(u)):l.debug("Please upload a valid .hex file"))})}document.querySelector("#app").innerHTML=`
<h1>MSPMO Flasher via UART</h1>
<h4>Supported Browsers: Chrome, Edge</h4>
<div class="container">
  <div class="left">
    <button id="connect" type="button">Connect</button>
    <input type="file" id="myfile" name="myfile" accept=".hex">
    <div id="dropZone" style="border: 2px dashed #ccc; padding: 10px; margin-top: 10px;">
      Drag and drop your file here
    </div>
    <div id="dropMessage" style="margin-top: 10px; color: green; display: none;">
      File has been uploaded successfully!
    </div><br><br>
    <input type="checkbox" id="toggleTraceLog" checked> Enable Trace Log
    <button id="getDeviceInfo" type="button">Get Device Info</button>
    <button id="erase" type="button">Mass Erase</button>
    <button id="flash" type="button">Flash</button>
    <button id="reset" type="button">Reset</button>
    <button id="verify" type="button">Verify</button>
    <textarea id="console" rows="15" cols="50" readonly></textarea>
  </div>
  <div id ="trace" class="right">
    <h4>Trace Log</h4>
    <textarea id="traceLog" rows="20" cols="50" readonly></textarea>
  </div>
</div>
`;const p=document.getElementById("toggleTraceLog"),g=document.getElementById("trace");console.log("trace",g,p);p&&g&&p.addEventListener("change",function(){g.style.display=="none"?g.style.display="inline":g.style.display="none"});b(document.querySelector("#connect"));N(document.querySelector("#getDeviceInfo"));F(document.querySelector("#erase"));C(document.querySelector("#flash"));v(document.querySelector("#myfile"));I(document.querySelector("#reset"));O(document.querySelector("#verify"));B(document.querySelector("#dropZone"),document.querySelector("#myfile"),document.querySelector("#dropMessage"));
