var p=Object.defineProperty;var A=(i,t,e)=>t in i?p(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var o=(i,t,e)=>A(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class y{constructor(t){o(this,"baudrate",9600);o(this,"buffer_size",1024*1024);o(this,"traceLog","");o(this,"lastTraceTime",Date.now());o(this,"tracing",!0);o(this,"leftOver",new Uint8Array(0));o(this,"reader");o(this,"slipReaderEnabled",!0);o(this,"trace_dom_log",!0);this.device=t,console.log("SerialTransport intialized")}_appendBuffer(t,e){const r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(e),t.byteLength),r.buffer}async read(t=0,e=12){let r,s=this.leftOver;if(this.leftOver=new Uint8Array(0),this.slipReaderEnabled){const n=this.slipReader(s);if(n.length>0)return n;s=this.leftOver,this.leftOver=new Uint8Array(0)}if(this.device.readable==null)return this.leftOver;this.reader=this.device.readable.getReader();try{t>0&&(r=setTimeout(()=>{this.reader&&this.reader.cancel()},t));do{if(!this.reader)throw new Error("Reader is undefined");const{value:n,done:a}=await this.reader.read();if(a&&(this.leftOver=s,console.log("Timeout")),!n)break;s=new Uint8Array(this._appendBuffer(s.buffer,n.buffer))}while(s.length<e)}finally{if(t>0&&clearTimeout(r),!this.reader)throw new Error("Reader is undefined");this.reader.releaseLock()}if(this.tracing&&(console.log("Read bytes"),this.trace(`Read ${s.length} bytes: ${this.hexConvert(s)}`)),this.slipReaderEnabled){const n=this.slipReader(s);return this.tracing&&(console.log("Slip reader results"),this.trace(`Slip Read ${n.length} bytes: ${this.hexConvert(n)}`)),n}return s}slipReader(t){let a=[],d=!1;for(const _ of t)_!==15968&&(_===219?d=!0:d?(_===220?a.push(15968):_===221&&a.push(219),d=!1):a.push(_));return new Uint8Array(a)}trace(t){const s=`${`TRACE ${(Date.now()-this.lastTraceTime).toFixed(3)}`} ${t}`;if(console.log(s),this.traceLog+=s+`
`,this.trace_dom_log){const n=document.querySelector("#traceLog");n&&(n.value=this.traceLog,n.scrollTop=n.scrollHeight)}}hexify(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("").padEnd(16," ")}hexConvert(t,e=!0){if(e&&t.length>16){let r="",s=t;for(;s.length>0;){const n=s.slice(0,16),a=String.fromCharCode(...n).split("").map(d=>d===" "||d>=" "&&d<="~"&&d!=="  "?d:".").join("");s=s.slice(16),r+=`
    ${this.hexify(n.slice(0,8))} ${this.hexify(n.slice(8))} | ${a}`}return r}else return this.hexify(t)}debug(t,e,r=!0,s=!0,n="#console"){if(r&&console.log(t,e),s){const a=document.querySelector(`${n}`);a&&(a.value+=t+`
`,a.scrollTop=a.scrollHeight)}}async sleep(t){return new Promise(e=>setTimeout(e,t))}async connect(t=this.baudrate){try{await this.device.open({baudRate:t,bufferSize:this.buffer_size}),this.debug("Device Connected"),this.leftOver=new Uint8Array(0)}catch(e){this.debug("Error in connect",e)}}async disconnect(){try{await this.device.close(),this.debug("Device Disconnected")}catch(t){this.debug("Error in disconnect",t)}}async send(t){if(this.device.writable){const e=this.device.writable.getWriter();await e.write(t),this.tracing&&this.trace(`Write ${t.length} bytes: ${this.hexConvert(t)}`),e.releaseLock()}}intelHexToUint8Array(t){const e=t.trim().split(`
`),r=[];return e.forEach(s=>{if(s.startsWith(":")){const n=parseInt(s.substr(1,2),16),a=9,d=a+n*2;for(let _=a;_<d;_+=2)r.push(parseInt(s.substr(_,2),16))}}),new Uint8Array(r)}async receive(t=0){if(this.leftOver.length!=0){const r=this.leftOver;return this.leftOver=new Uint8Array(0),r}if(!this.device.readable)return this.leftOver;this.reader=this.device.readable.getReader();let e;try{if(t>0&&(e=setTimeout(()=>{this.reader&&this.reader.cancel()},t)),!this.reader)throw new Error("Reader is undefined");const{value:r,done:s}=await this.reader.read();return console.log("Raw Read bytes",r),s?r||new Uint8Array(0):(this.tracing&&(console.log("Raw Read bytes"),this.trace(`Read ${r.length} bytes: ${this.hexConvert(r)}`)),r)}finally{if(t>0&&clearTimeout(e),!this.reader)throw new Error("Reader is undefined");this.reader.releaseLock()}}}var h=(i=>(i[i.ALIGN_DEFAULT=0]="ALIGN_DEFAULT",i[i.ALIGN_TOP_LEFT=1]="ALIGN_TOP_LEFT",i[i.ALIGN_TOP_MID=2]="ALIGN_TOP_MID",i[i.ALIGN_TOP_RIGHT=3]="ALIGN_TOP_RIGHT",i[i.ALIGN_BOTTOM_LEFT=4]="ALIGN_BOTTOM_LEFT",i[i.ALIGN_BOTTOM_MED=5]="ALIGN_BOTTOM_MED",i[i.ALIGN_BOTTOM_RIGHT=6]="ALIGN_BOTTOM_RIGHT",i[i.ALIGN_LEFT_MID=7]="ALIGN_LEFT_MID",i[i.ALIGN_RIGHT_MID=8]="ALIGN_RIGHT_MID",i[i.ALIGN_CENTER=9]="ALIGN_CENTER",i))(h||{}),u=(i=>(i[i.BSL_ACK=0]="BSL_ACK",i[i.BSL_ERROR_HEADER_INCORRECT=81]="BSL_ERROR_HEADER_INCORRECT",i[i.BSL_ERROR_CHECKSUM_INCORRECT=82]="BSL_ERROR_CHECKSUM_INCORRECT",i[i.BSL_ERROR_PACKET_SIZE_ZERO=83]="BSL_ERROR_PACKET_SIZE_ZERO",i[i.BSL_ERROR_PACKET_SIZE_TOO_BIG=84]="BSL_ERROR_PACKET_SIZE_TOO_BIG",i[i.BSL_ERROR_UNKNOWN_ERROR=85]="BSL_ERROR_UNKNOWN_ERROR",i[i.BSL_ERROR_UNKNOWN_BAUD_RATE=86]="BSL_ERROR_UNKNOWN_BAUD_RATE",i))(u||{});class c{static softwareCRC(t,e){let r=4294967295;for(let s=0;s<e;s++){let n=t[s];r=r^n;for(let a=0;a<8;a++){const d=-(r&1);r=r>>>1^this.CRC32_POLYNOMIAL&d}}return r=r>>>0,new Uint8Array([r&255,r>>>8&255,r>>>16&255,r>>>24&255])}static async getFrameRaw(t){switch(t.type){case"Connection":{const e=this.softwareCRC(new Uint8Array([this.CONNECTION]),1);return new Uint8Array([this.HEADER,1,0,this.CONNECTION,...e])}case"StartApp":{const e=this.softwareCRC(new Uint8Array([this.START_APP]),1);return new Uint8Array([this.HEADER,1,0,this.START_APP,...e])}case"GetDeviceInfo":{const e=this.softwareCRC(new Uint8Array([this.GET_DEVICE_INFO]),1);return new Uint8Array([this.HEADER,1,0,this.GET_DEVICE_INFO,...e])}case"MassErase":{const e=this.softwareCRC(new Uint8Array([this.MASS_ERASE]),1);return new Uint8Array([this.HEADER,1,0,this.MASS_ERASE,...e])}case"ProgramData":{const e=t.data,r=[t.start_address>>24&255,t.start_address>>16&255,t.start_address>>8&255,t.start_address&255],s=e.length+4+1,n=this.softwareCRC(new Uint8Array([this.PROGRAM_DATA,...r,...e]),s);return new Uint8Array([this.HEADER,s&255,s>>8,this.PROGRAM_DATA,...r,...e,...n])}case"UnlockBootloader":{const e=t.data;if(e.length!=32)throw new Error("Data length should be 32");const r=e.length+1,s=this.softwareCRC(new Uint8Array([this.UNLOCK_BOOTLOADER,...e]),r);return new Uint8Array([this.HEADER,r&255,r>>8,this.UNLOCK_BOOTLOADER,...e,...s])}case"MemoryRead":{const e=t.data;if(e.length!=4)throw new Error("Data length should be 4");const r=[t.start_address>>24&255,t.start_address>>16&255,t.start_address>>8&255,t.start_address&255],s=e.length+4+1,n=this.softwareCRC(new Uint8Array([this.MEMORY_READ,...r,...e]),s);return new Uint8Array([this.HEADER,s&255,s>>8,this.MEMORY_READ,...r,...e,...n])}default:throw new Error("Unimplemented command")}}static getResponse(t,e){switch(e.type){case"Connection":case"StartApp":return{type:e.type,response:t[0]};case"MassErase":case"ProgramData":case"UnlockBootloader":return{type:e.type,response:t[5]};case"GetDeviceInfo":return{type:e.type,response:t[5],CMD_interpreter_version:t[this.OFFSET_BYTE+2]<<8|t[this.OFFSET_BYTE+1],build_id:t[this.OFFSET_BYTE+4]<<8|t[this.OFFSET_BYTE+3],app_version:t[this.OFFSET_BYTE+8]<<24|t[this.OFFSET_BYTE+7]<<16|t[this.OFFSET_BYTE+6]<<8|t[this.OFFSET_BYTE+5],active_plugin_interface_version:t[this.OFFSET_BYTE+10]<<8|t[this.OFFSET_BYTE+9],BSL_max_buffer_size:t[this.OFFSET_BYTE+12]<<8|t[this.OFFSET_BYTE+11],BSL_buffer_start_address:t[this.OFFSET_BYTE+16]<<24|t[this.OFFSET_BYTE+15]<<16|t[this.OFFSET_BYTE+14]<<8|t[this.OFFSET_BYTE+13],BCR_config_id:t[this.OFFSET_BYTE+20]<<24|t[this.OFFSET_BYTE+19]<<16|t[this.OFFSET_BYTE+18]<<8|t[this.OFFSET_BYTE+17],BSL_config_id:t[this.OFFSET_BYTE+24]<<24|t[this.OFFSET_BYTE+23]<<16|t[this.OFFSET_BYTE+22]<<8|t[this.OFFSET_BYTE+21]};default:throw new Error("Unimplemented command")}}}o(c,"HEADER",128),o(c,"CONNECTION",18),o(c,"UNLOCK_BOOTLOADER",33),o(c,"FLASH_RANGE_ERASE",35),o(c,"MASS_ERASE",21),o(c,"PROGRAM_DATA",32),o(c,"PROGRAM_DATA_FAST",36),o(c,"MEMORY_READ",41),o(c,"FACTORY_RESET",48),o(c,"GET_DEVICE_INFO",25),o(c,"STANDALONE_VERIFY",49),o(c,"START_APP",64),o(c,"CRC32_POLYNOMIAL",3988292384),o(c,"INITIAL_SEED",4294967295),o(c,"OFFSET_BYTE",4);class L extends y{constructor(e){super(e);o(this,"BSL_TRY",0);o(this,"BSL_TRY_MAX",10);o(this,"DEFAULT_TIMEOUT",2e3);o(this,"conn_established",!1);o(this,"FLASH_START_ADDRESS",0);o(this,"FLASH_MAX_BUFFER_SIZE",0);o(this,"BSL_PW_RESET",[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]);o(this,"MEMORY_READ_RESPONSE",48);o(this,"DEVICE_INFO_RESPONSE",49);o(this,"STANDALONE_VERIFY_RESPONSE",50);o(this,"MESSAGE_RESPONSE",59);o(this,"ERROR_RESPONSE",58);o(this,"ESP_CMD",{BSL_ENBL:["B","S","L"],OLED_CLR:["O","L","D","R","S","T"],OLED_ON:["O","L","D","O","N"],OLED_OFF:["O","L","D","O","F","F"],OLED_PRINT:["O","L","D","W","R","T"]})}sa2a(e){let r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e[s].charCodeAt(0);return r}s2a(e){let r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return r}async enableBSL(){await this.send(new Uint8Array(this.sa2a(this.ESP_CMD.BSL_ENBL))),await this.read(this.DEFAULT_TIMEOUT,5),await this.sleep(100)}async control_esp_oled(e){await this.send(this.sa2a(e)),await this.receive()}async establish_conn(){this.BSL_TRY++,this.debug("Enabling BSL Mode..."),await this.enableBSL();let e={type:"Connection"},r=await c.getFrameRaw(e);await this.send(r);let s=await this.read(this.DEFAULT_TIMEOUT*2,1),n=c.getResponse(s,e);if(n.response==u.BSL_ACK)await this.esp_oled_print("BSL Mode Enabled",h.ALIGN_BOTTOM_LEFT,0,0),this.BSL_TRY=0,this.conn_established=!0,this.debug("BSL Mode Enabled"),await this.get_device_info();else{if(this.debug("BSL Mode Enable Failed",n.response),this.BSL_TRY<this.BSL_TRY_MAX){this.debug(`Retrying...(attempt : ${this.BSL_TRY})`),await this.establish_conn();return}throw this.conn_established=!1,new Error("BSL Mode Enable Failed")}}check_crc(e){const r=e[3]<<8|e[2],s=e.slice(4,3+r),n=c.softwareCRC(s,r),a=n[0]<<24|n[1]<<16|n[2]<<8|n[3],d=e[e.length-4]<<24|e[e.length-3]<<16|e[e.length-2]<<8|e[e.length-1];if(a!=d)throw this.debug("CRC Check Failed"),new Error("CRC Check Failed");return!0}async esp_oled_print(e,r=h.ALIGN_DEFAULT,s=0,n=0,a=!0){a&&(await this.send(new Uint8Array(this.sa2a(this.ESP_CMD.OLED_CLR))),await this.read(this.DEFAULT_TIMEOUT,8));let d=new Uint8Array([...this.sa2a(this.ESP_CMD.OLED_PRINT),r,s,n,...this.s2a(e)]);await this.send(d),await this.read(this.DEFAULT_TIMEOUT,5)}async get_device_info(){this.conn_established||this.establish_conn();const e={type:"GetDeviceInfo"},r=await c.getFrameRaw(e);await this.send(r);const s=await this.read(this.DEFAULT_TIMEOUT,33),n=this.slipReader(s);this.check_crc(n);let a=c.getResponse(n,e);a.response==u.BSL_ACK&&a.type=="GetDeviceInfo"?(this.FLASH_MAX_BUFFER_SIZE=a.BSL_max_buffer_size,this.FLASH_START_ADDRESS=a.BSL_buffer_start_address,this.debug(`Device Info:
        CMD_interpreter_version: 0x${a.CMD_interpreter_version.toString(16)}
        build_id: 0x${a.build_id.toString(16)}
        app_version: 0x${a.app_version.toString(16)}
        active_plugin_interface_version: 0x${a.active_plugin_interface_version.toString(16)}
        BSL_max_buffer_size: 0x${a.BSL_max_buffer_size.toString(16)}
        BSL_buffer_start_address: 0x${a.BSL_buffer_start_address.toString(16)}
        BCR_config_id: 0x${a.BCR_config_id.toString(16)}
        BSL_config_id: 0x${a.BSL_config_id.toString(16)}`),await this.unlock_bootloader()):this.debug("Device Info Failed",a.response)}async unlock_bootloader(){this.conn_established||await this.establish_conn(),this.debug("Unlocking Bootloader ...");let e={type:"UnlockBootloader",data:new Uint8Array(this.BSL_PW_RESET)},r=await c.getFrameRaw(e);await this.send(r);let s=await this.read(this.DEFAULT_TIMEOUT,10),n=c.getResponse(s,e);if(n.response==u.BSL_ACK)this.debug("Bootloader Unlocked");else throw this.debug("Bootloader Unlock Failed",n.response),new Error("Bootloader Unlock Failed")}async mass_earse(){this.conn_established||await this.establish_conn(),await this.esp_oled_print("Erasing ...",h.ALIGN_TOP_LEFT,0,0),this.debug("Mass Erasing ...");let e={type:"MassErase"},r=await c.getFrameRaw(e);await this.send(r),console.log("send is",this.hexify(r));let s=await this.read(this.DEFAULT_TIMEOUT,10),n=c.getResponse(s,e);n.response==u.BSL_ACK?(this.debug("Mass Erase Done"),await this.esp_oled_print("Erase Done",h.ALIGN_BOTTOM_LEFT,0,0)):(this.conn_established=!1,this.debug("Mass Erase Failed",n.response),await this.esp_oled_print("Erase Failed",h.ALIGN_BOTTOM_LEFT,0,0))}async program_data(e){this.conn_established||await this.establish_conn(),await this.esp_oled_print("Flashing...",h.ALIGN_BOTTOM_LEFT,0,0),await this.esp_oled_print("[=====100%=====]",h.ALIGN_LEFT_MID,0,0,!1);const n={type:"ProgramData",start_address:0,data:this.intelHexToUint8Array(e)};let a=await c.getFrameRaw(n);await this.send(a);let d=await this.read(this.DEFAULT_TIMEOUT,10),_=c.getResponse(d,n);if(_.response==u.BSL_ACK)this.debug("Data Programmed"),await this.esp_oled_print("Firmware Flashed",h.ALIGN_BOTTOM_LEFT,0,0);else throw this.conn_established=!1,await this.esp_oled_print("Error Flashing",h.ALIGN_BOTTOM_LEFT,0,0),this.debug("Data Program Failed",_.response),new Error("Data Program Failed")}async read_memory(){this.conn_established||await this.establish_conn(),await this.esp_oled_print("Reading...",h.ALIGN_BOTTOM_LEFT,0,0);let e=new Uint8Array([128,9,0,41,0,12,0,0,8,0,0,0,50,157,176,53]);await this.send(e),this.receive()}async flash_earse_range(){this.debug("to be implemneted ")}async start_app(){this.conn_established||this.establish_conn();let e={type:"StartApp"},r=await c.getFrameRaw(e);await this.send(r);let s=await this.read(this.DEFAULT_TIMEOUT,1),n=c.getResponse(s,e);n.response==u.BSL_ACK?(this.conn_established=!1,await this.esp_oled_print("App Started",h.ALIGN_BOTTOM_LEFT,0,0),this.debug("App Started")):this.debug("App Start Failed",n.response)}}let E=!1,w,l,f;const S=[{usbVendorId:12346,usbProductId:4097},{usbVendorId:45488,usbProductId:32853}];function b(i){i.addEventListener("click",()=>{if(E&&l){l.disconnect(),i.innerHTML="Connect",E=!1;return}navigator.serial.requestPort({filters:S}).then(async t=>{l=await new L(t),await l.connect(),i.innerHTML="disconnect",E=!0}).catch(t=>{console.error(t),l.debug("Error Connecting"),w.disconnect(),i.innerHTML="Connect",E=!1})})}function F(i){i.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}i.innerHTML="Erasing...";try{await l.mass_earse()}catch(t){console.log(t),l.debug("Error Erasing")}i.innerHTML="Mass Erase"})}function O(i){i.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}if(!f){l.debug("Please upload a .Hex file first");return}i.innerHTML="Flashing...";try{await l.program_data(f),l.debug("Flashing Done")}catch{l.debug("Error Flashing")}i.innerHTML="Flash"})}function I(i){i.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}i.innerHTML="Verifying...";try{await l.read_memory()}catch(t){console.log(t),l.debug("Error Verifying")}i.innerHTML="Verify"})}function R(i){return new Promise((t,e)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=e,r.readAsText(i)})}function C(i){i.addEventListener("change",async t=>{f="";const e=t.target.files[0];e&&e.name.endsWith(".hex")?(f=await R(e),console.log(f)):l.debug("Please upload a valid .hex file")})}function B(i){i.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}i.innerHTML="Resting...",await l.start_app(),i.innerHTML="Reset"})}function v(i){i.addEventListener("click",async()=>{if(!E){l.debug("Please Connect First");return}i.innerHTML="Getting Device Info...";try{await l.establish_conn()}catch(t){console.log(t),l.debug("Error Getting Device Info")}i.innerHTML="Get Device Info"})}function M(i,t,e){i.addEventListener("dragover",r=>{r.preventDefault(),i.style.borderColor="#646cff"}),i.addEventListener("dragleave",()=>{i.style.borderColor="#ccc"}),i.addEventListener("drop",async r=>{if(r.preventDefault(),i.style.borderColor="#ccc",!r.dataTransfer)return;const s=r.dataTransfer.files;s.length>0&&(e.style.display="block",t.files=s,s&&s[0].name.endsWith(".hex")?(f=await R(s[0]),console.log(f)):l.debug("Please upload a valid .hex file"))})}document.querySelector("#app").innerHTML=`
<h1>MSPMO Flasher via UART</h1>
<h4>Supported Browsers: Chrome, Edge</h4>
<div class="container">
  <div class="left">
    <button id="connect" type="button">Connect</button>
    <input type="file" id="myfile" name="myfile" accept=".hex">
    <div id="dropZone" style="border: 2px dashed #ccc; padding: 10px; margin-top: 10px;">
      Drag and drop your file here
    </div>
    <div id="dropMessage" style="margin-top: 10px; color: green; display: none;">
      File has been uploaded successfully!
    </div><br><br>
    <input type="checkbox" id="toggleTraceLog" checked> Enable Trace Log
    <button id="getDeviceInfo" type="button">Get Device Info</button>
    <button id="erase" type="button">Mass Erase</button>
    <button id="flash" type="button">Flash</button>
    <button id="reset" type="button">Reset</button>
    <button id="verify" type="button">Verify</button>
    <textarea id="console" rows="15" cols="50" readonly></textarea>
  </div>
  <div id ="trace" class="right">
    <h4>Trace Log</h4>
    <textarea id="traceLog" rows="20" cols="50" readonly></textarea>
  </div>
</div>
`;const g=document.getElementById("toggleTraceLog"),T=document.getElementById("trace");console.log("trace",T,g);g&&T&&g.addEventListener("change",function(){T.style.display=="none"?T.style.display="inline":T.style.display="none"});b(document.querySelector("#connect"));v(document.querySelector("#getDeviceInfo"));F(document.querySelector("#erase"));O(document.querySelector("#flash"));C(document.querySelector("#myfile"));B(document.querySelector("#reset"));I(document.querySelector("#verify"));M(document.querySelector("#dropZone"),document.querySelector("#myfile"),document.querySelector("#dropMessage"));
